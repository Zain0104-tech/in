// ==UserScript==
// @name         Iran Lithium Battery Project Report Viewer (Bilingual)
// @namespace    http://tampermonkey.net/
// @version      1.0.0
// @description  Bilingual (ZH/EN) report viewer with Shadow DOM, Self-Test, and offline capability.
// @author       Senior Front-End Engineer
// @match        *://*/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_deleteValue
// @run-at       document-end
// ==/UserScript==

/*
 * ======================================================================================
 * README & DOCUMENTATION
 * ======================================================================================
 *
 * INSTALLATION:
 * 1. Install Tampermonkey or Greasemonkey extension in your browser.
 * 2. Create a new script and paste this entire file content.
 * 3. Save.
 *
 * USAGE:
 * - A floating button (üìù) appears in the bottom-right of the screen.
 * - Click it or press 'F9' to toggle the Report Viewer.
 * - Press '/' to focus the search bar.
 * - Use the header icons to switch Language, Theme, Print, or Export.
 *
 * DATA SOURCE:
 * - The report content is stored in the `REPORT_JSON` constant below.
 * - To update content, replace the `REPORT_JSON` object structure.
 *
 * SELF-TEST / AUDIT:
 * - The script runs a diagnostic routine on first load.
 * - Checks: Environment, Content Integrity, A11y Contrast, Performance, Security.
 * - Results are logged to LocalStorage and viewable via the Flask icon in the header.
 *
 * DEPENDENCIES:
 * - Tailwind CSS (v2.2.19) is injected via CDN into the Shadow DOM.
 * - No external JavaScript libraries are used.
 *
 * ======================================================================================
 */

(function () {
    'use strict';

    // ==================================================================================
    // 1. CONFIGURATION & DATA SOURCE
    // ==================================================================================

    const CONFIG = {
        storagePrefix: 'ir_lithium_rpt_',
        cdnTailwind: 'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css',
        debug: false, // Set to true for verbose console logging
        animationDuration: 300,
        keys: {
            toggleUI: 'F9',
            search: '/'
        }
    };

    const UI_LABELS = {
        en: {
            searchPlaceholder: "Search report...",
            toc: "Table of Contents",
            settings: "Settings",
            exportHtml: "Export HTML",
            exportJson: "Export JSON",
            print: "Print Mode",
            close: "Close",
            testTitle: "System Self-Test Report",
            testRun: "Run Self-Test",
            pass: "PASS",
            fail: "FAIL",
            loading: "Loading Report...",
            noResults: "No results found."
        },
        zh: {
            searchPlaceholder: "ÊêúÁ¥¢Êä•Âëä...",
            toc: "ÁõÆÂΩï",
            settings: "ËÆæÁΩÆ",
            exportHtml: "ÂØºÂá∫ HTML",
            exportJson: "ÂØºÂá∫ JSON",
            print: "ÊâìÂç∞Ê®°Âºè",
            close: "ÂÖ≥Èó≠",
            testTitle: "Á≥ªÁªüËá™Ê£ÄÊä•Âëä",
            testRun: "ËøêË°åËá™Ê£Ä",
            pass: "ÈÄöËøá",
            fail: "Â§±Ë¥•",
            loading: "Âä†ËΩΩÊä•Âëä‰∏≠...",
            noResults: "Êú™ÊâæÂà∞ÁªìÊûú„ÄÇ"
        }
    };

    // --- REPORT DATA START ---
    const REPORT_JSON = {
        "report": {
            "meta": {
                "title": {
                    "zh": "‰ºäÊúóÈîÇÁîµÊ±†SKDÁªÑË£Ö‰∫ßÁ∫øÈ°πÁõÆÂèØË°åÊÄßÂàÜÊûêÊä•Âëä",
                    "en": "Feasibility Study Report: Iran Lithium Battery SKD Assembly Line Project"
                },
                "date": "2025-12-08",
                "type": {
                    "zh": "Á£∑ÈÖ∏ÈìÅÈîÇÔºàLFPÔºâÂÇ®ËÉΩÁîµÊ±†ÂçäËá™Âä®ÁªÑË£ÖÁ∫øÔºàSKDÊ®°ÂºèÔºâ",
                    "en": "Semi-automatic LFP Energy Storage Battery Assembly Line (SKD Mode)"
                },
                "market": {
                    "zh": "‰ºäÊúó‰ΩèÂÆÖÂÇ®ËÉΩÁ≥ªÁªü„ÄÅÂïÜ‰∏öÂ§áÁîµ„ÄÅÁ¶ªÁΩëÂÖâ‰ºèÁ≥ªÁªü",
                    "en": "Iran residential energy storage, commercial backup, off-grid PV systems"
                }
            },
            "sections": [
                {
                    "id": "executive_summary",
                    "title": { "zh": "ÊâßË°åÊëòË¶Å", "en": "Executive Summary" },
                    "paragraphs": [
                        {
                            "zh": "Êú¨È°πÁõÆÊó®Âú®Âà©Áî®‰ºäÊúóÂÖ≥Á®éÊîøÁ≠ñ‰∏≠ÁöÑÊï¥Êï£‰ª∂Á®éÂ∑Æ‰ºòÂäøÔºåÈÄöËøá‰ªé‰∏≠ÂõΩÈááË¥≠Ê†áÂáÜÁîµËäØ‰∏éBMSÁªÑ‰ª∂ÔºåÂú®‰ºäÊúóÊú¨Âú∞ÂÆåÊàêPACKÁªÑË£ÖÔºå‰ª•Êª°Ë∂≥Êó•ÁõäÂ¢ûÈïøÁöÑÂÇ®ËÉΩÈúÄÊ±Ç„ÄÇ",
                            "en": "This project aims to leverage Iran‚Äôs tariff differential between complete products and SKD parts by importing standard cells and BMS from China, then completing PACK assembly locally to meet the rising demand for energy storage."
                        },
                        {
                            "zh": "È°πÁõÆÈááÁî®ÂçäËá™Âä®Ë∑ØÁ∫øÔºå‰ª•Âπ≥Ë°°ÊäïËµÑÊàêÊú¨„ÄÅËøêËê•ÂèØË°åÊÄß‰ª•ÂèäÊäÄÊúØ‰∫∫ÊâçÁü≠Áº∫ÁöÑÁé∞Áä∂„ÄÇ",
                            "en": "The project adopts a semi-automatic production route to balance investment cost, operational feasibility, and Iran‚Äôs shortage of skilled technicians."
                        },
                        {
                            "zh": "ÂèØË°åÊÄßËØÑÁ∫ßÔºö‰∏≠Á≠âÂÅèÈ´òÔºõÊäïËµÑÂª∫ËÆÆÔºöÂÖàËØïÁÇπÂÜçÊâ©Â§ßËßÑÊ®°ÔºõÂÖ≥ÈîÆÈ£éÈô©ÔºöÂà∂Ë£ÅÊîØ‰ªòÈ£éÈô©„ÄÅÊäÄÊúØ‰∫∫ÊâçÁü≠Áº∫„ÄÅÊîøÁ≠ñ‰∏çÁ°ÆÂÆöÊÄß„ÄÇ",
                            "en": "Feasibility rating: Medium-high; Investment recommendation: Begin with a pilot before expansion; Key risks: sanctions-related payment issues, talent shortage, policy uncertainty."
                        }
                    ]
                },
                {
                    "id": "market_analysis",
                    "title": { "zh": "Â∏ÇÂú∫ÈúÄÊ±ÇÂàÜÊûê", "en": "Market Analysis" },
                    "subsections": [
                        {
                            "id": "power_shortage",
                            "title": { "zh": "ÁîµÂäõÁü≠Áº∫Áé∞Áä∂", "en": "Current Power Shortage" },
                            "paragraphs": [
                                {
                                    "zh": "2024Âπ¥Â§èÂ≠£ÁîµÂäõÁº∫Âè£Ëææ20000ÂÖÜÁì¶ÔºåÈ¢ÑËÆ°2025Âπ¥Êâ©Â§ßËá≥26000ÂÖÜÁì¶ÔºõÊó•ÂùáÂÅúÁîµÁ∫¶3Â∞èÊó∂Ôºå‰∏•ÈáçÂΩ±ÂìçÂ±ÖÊ∞ëÁîüÊ¥ª‰∏éÂ∑•‰∏öÁîü‰∫ß„ÄÇ",
                                    "en": "In summer 2024, Iran‚Äôs power deficit reached 20,000 MW and is expected to rise to 26,000 MW in 2025. Daily power outages average 3 hours, affecting residential and industrial sectors."
                                },
                                {
                                    "zh": "Âæ∑ÈªëÂÖ∞Áî®ÁîµË¥üËç∑Âç†ÂÖ®ÂõΩ18%ÔºåË¥üËç∑Ôºà15.3GWÔºâÊòæËëóÈ´ò‰∫éÁîµÁΩëÊâøËΩΩËÉΩÂäõÔºà12GWÔºâ„ÄÇ",
                                    "en": "Tehran accounts for 18% of national electricity demand, with a load of 15.3 GW far exceeding the grid capacity of 12 GW."
                                },
                                {
                                    "zh": "ÊîøÂ∫úËÆ°ÂàíÂú®2026Âπ¥ÂâçÂ∞ÜÂèØÂÜçÁîüËÉΩÊ∫êË£ÖÊú∫ÊèêÂçáÂà∞11GWÔºåÂπ∂Â∑≤ÈááË¥≠7GWÂ§™Èò≥ËÉΩÁªÑ‰ª∂„ÄÇ",
                                    "en": "The government plans to increase renewable energy capacity to 11 GW by 2026 and has already procured 7 GW of solar modules."
                                }
                            ]
                        },
                        {
                            "id": "storage_market",
                            "title": { "zh": "ÂÇ®ËÉΩÂ∏ÇÂú∫ËßÑÊ®°", "en": "Energy Storage Market Size" },
                            "paragraphs": [
                                {
                                    "zh": "2023Âπ¥ÂÇ®ËÉΩÂ∏ÇÂú∫Á∫¶1GWhÔºå2025Âπ¥È¢ÑËÆ°Â¢ûÈïøËá≥3GWhÔºåÂπ¥Â§çÂêàÂ¢ûÈïøÁéáÁ∫¶25%„ÄÇ",
                                    "en": "The energy storage market grew from approximately 1 GWh in 2023 to an estimated 3 GWh in 2025, representing a 25% CAGR."
                                },
                                {
                                    "zh": "ÂÇ®ËÉΩÊäïËµÑËßÑÊ®°Á∫¶10‰∫øÁæéÂÖÉÔºåÂõΩÈôÖÊäïËµÑËÄÖÂç†ÊØîË∂ÖËøá50%„ÄÇ",
                                    "en": "Total storage investment is around USD 1 billion, with international investors contributing over 50%."
                                }
                            ]
                        },
                        {
                            "id": "customer_segments",
                            "title": { "zh": "ÁõÆÊ†áÂÆ¢Êà∑ÂàÜÊûê", "en": "Target Customer Segments" },
                            "paragraphs": [
                                {
                                    "zh": "‰ΩèÂÆÖÁî®Êà∑Ôºà35%ÔºâÔºö5‚Äì10kWh Êà∑Áî®ÂÇ®ËÉΩÈúÄÊ±ÇÂø´ÈÄüÂ¢ûÈïø„ÄÇ",
                                    "en": "Residential users (35%): Strong demand for 5‚Äì10 kWh home storage systems."
                                },
                                {
                                    "zh": "ÂïÜ‰∏öÁî®Êà∑Ôºà30%ÔºâÔºöÁî®‰∫éÂïÜÈì∫„ÄÅÊúçÂä°Âô®‰∏éÂ∞èÂûã‰ºÅ‰∏öÁöÑÂ§áÁî®ÁîµÊ∫ê„ÄÇ",
                                    "en": "Commercial users (30%): Backup power for shops, servers, and small businesses."
                                },
                                {
                                    "zh": "ÂÖâ‰ºèÂÆâË£ÖÂïÜÔºà25%ÔºâÔºöÊâÄÊúâÂÖâ‰ºèÈ°πÁõÆÈúÄÈÖçÂ•óËá≥Â∞ë15%ÂÇ®ËÉΩÂÆπÈáè„ÄÇ",
                                    "en": "PV integrators (25%): All new PV projects must include at least 15% storage capacity."
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "technical_feasibility",
                    "title": { "zh": "ÊäÄÊúØÂèØË°åÊÄßÂàÜÊûê", "en": "Technical Feasibility Analysis" },
                    "subsections": [
                        {
                            "id": "technical_route",
                            "title": { "zh": "ÊäÄÊúØË∑ØÁ∫øÈÄâÊã©", "en": "Technology Route" },
                            "paragraphs": [
                                {
                                    "zh": "ÂçäËá™Âä®Ë∑ØÁ∫øÊäïËµÑÊàêÊú¨Á∫¶‰∏∫ÂÖ®Ëá™Âä®Á∫øÁöÑ60%-70%ÔºåÈÄÇÂêàÂΩìÂú∞ÊäÄÊúØÊ∞¥Âπ≥‰∏éÁª¥Êä§ËÉΩÂäõ„ÄÇ",
                                    "en": "The semi-automatic route requires 60‚Äì70% of the investment of a fully automated line and fits Iran‚Äôs technical and maintenance constraints."
                                },
                                {
                                    "zh": "Ê†∏ÂøÉÂ∑•Ëâ∫ÂåÖÊã¨OCV/IRÊµãËØï„ÄÅÂ†ÜÂè†ÊçÜÊâé„ÄÅÊøÄÂÖâÁÑäÊé•„ÄÅBMSÈõÜÊàê„ÄÅEOLÊµãËØï„ÄÇ",
                                    "en": "Core processes include OCV/IR testing, stacking/banding, laser welding, BMS integration, and EOL testing."
                                }
                            ]
                        },
                        {
                            "id": "equipment",
                            "title": { "zh": "ËÆæÂ§á‰∏éÊäïËµÑ", "en": "Equipment & Investment" },
                            "paragraphs": [
                                {
                                    "zh": "5‚Äì10MWh Âπ¥‰∫ßÁ∫øÊäïËµÑÁ∫¶ 70,500‚Äì125,500 ÁæéÂÖÉÔºå‰∏ªË¶ÅÁî±ÊøÄÂÖâÁÑäÊé•„ÄÅÂàÜÈÄâ„ÄÅÂÖÖÊîæÁîµËÆæÂ§áÊûÑÊàê„ÄÇ",
                                    "en": "A 5‚Äì10 MWh annual line requires USD 70,500‚Äì125,500 in equipment, mainly for welding, sorting, and testing."
                                }
                            ]
                        },
                        {
                            "id": "facility",
                            "title": { "zh": "ÂéÇÊàø‰∏éÂü∫Á°ÄËÆæÊñΩ", "en": "Facility Requirements" },
                            "paragraphs": [
                                {
                                    "zh": "ÂéÇÊàøÈúÄÊ±Ç 800‚Äì1200 Âπ≥ÊñπÁ±≥ÔºåÈúÄË¶ÅÈò≤ÈùôÁîµÂú∞Âù™„ÄÅÈô§ÊπøÁ≥ªÁªü„ÄÅ400kVA ÂèòÂéãÂô®„ÄÇ",
                                    "en": "Facilities require 800‚Äì1200 sqm, anti-static flooring, dehumidification systems, and a 400 kVA transformer."
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "financial_feasibility",
                    "title": { "zh": "Ë¥¢Âä°ÂèØË°åÊÄßÂàÜÊûê", "en": "Financial Feasibility Analysis" },
                    "subsections": [
                        {
                            "id": "cost_structure",
                            "title": { "zh": "ÊàêÊú¨ÁªìÊûÑÂàÜÊûê", "en": "Cost Structure" },
                            "paragraphs": [
                                {
                                    "zh": "5kWh ÁîµÊ±†ÂåÖ SKD ÊàêÊú¨Á∫¶ 416 ÁæéÂÖÉÔºåÁõ∏ÊØî CBU Ê®°ÂºèÈôç‰ΩéÁ∫¶ 11.7%„ÄÇ",
                                    "en": "A 5 kWh battery pack costs USD 416 under the SKD model, around 11.7% cheaper than CBU."
                                }
                            ]
                        },
                        {
                            "id": "roi",
                            "title": { "zh": "ÊäïËµÑÂõûÊä•", "en": "Return on Investment" },
                            "paragraphs": [
                                {
                                    "zh": "Âπ¥‰∫ß 5MWhÔºåÂèØÂÆûÁé∞Âπ¥Êî∂ÂÖ• 55 ‰∏áÁæéÂÖÉÔºåÊØõÂà©ÁéáÁ∫¶ 24%ÔºåÊäïËµÑÂõûÊî∂Êúü 2.75 Âπ¥„ÄÇ",
                                    "en": "With 5 MWh annual output, revenue reaches USD 550,000, gross margin ~24%, and payback period 2.75 years."
                                }
                            ]
                        },
                        {
                            "id": "sensitivity",
                            "title": { "zh": "ÊïèÊÑüÊÄßÂàÜÊûê", "en": "Sensitivity Analysis" },
                            "paragraphs": [
                                {
                                    "zh": "ÂÖ≥ÈîÆÂèòÈáèÂåÖÊã¨ÁîµËäØ‰ª∑Ê†º„ÄÅÈîÄÂîÆ‰ª∑Ê†º„ÄÅ‰∫ßËÉΩÂà©Áî®ÁéáÂíåÂÖ≥Á®éÊîøÁ≠ñ„ÄÇ",
                                    "en": "Key variables include cell price, selling price, utilization rate, and tariff policy."
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "policy",
                    "title": { "zh": "ÊîøÁ≠ñ‰∏éÂêàËßÑÂàÜÊûê", "en": "Policy & Compliance" },
                    "subsections": [
                        {
                            "id": "investment_policy",
                            "title": { "zh": "ÊäïËµÑÊîøÁ≠ñÁéØÂ¢É", "en": "Investment Policy Environment" },
                            "paragraphs": [
                                {
                                    "zh": "‰ºäÊúóÂÖÅËÆ∏Â§ñËµÑÂú®Âà∂ÈÄ†‰∏öËÆæÁ´ãÁã¨ËµÑ‰ºÅ‰∏öÔºåÈÉ®ÂàÜËá™Áî±Âå∫ÂèØ‰∫´Âèó 10 Âπ¥ÂÖçÁ®é„ÄÇ",
                                    "en": "Iran allows wholly foreign-owned manufacturing enterprises; free zones offer up to 10 years of tax exemption."
                                }
                            ]
                        },
                        {
                            "id": "tariffs",
                            "title": { "zh": "ÂÖ≥Á®éÊîøÁ≠ñ", "en": "Tariff Policy" },
                            "paragraphs": [
                                {
                                    "zh": "ÁîµÊ±†ÊàêÂìÅÂÖ≥Á®é 15%-20%ÔºåÈõ∂ÈÉ®‰ª∂ 5%-10%ÔºåSKD Ê®°ÂºèÊòæËëóÈôç‰ΩéÊï¥‰ΩìËøõÊàêÊú¨„ÄÇ",
                                    "en": "Finished batteries face 15‚Äì20% tariffs; components 5‚Äì10%; SKD significantly reduces landed cost."
                                }
                            ]
                        },
                        {
                            "id": "certification",
                            "title": { "zh": "ÊäÄÊúØÊ†áÂáÜ‰∏éËÆ§ËØÅ", "en": "Technical Standards & Certification" },
                            "paragraphs": [
                                {
                                    "zh": "ÈúÄÁ¨¶Âêà ISIRI-IEC 62619„ÄÅISIRI 62133 ‰ª•Âèä UN38.3„ÄÇ",
                                    "en": "Compliance with ISIRI-IEC 62619, ISIRI 62133, and UN38.3 is required."
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "risk",
                    "title": { "zh": "È£éÈô©ËØÑ‰º∞‰∏éÁ≠ñÁï•", "en": "Risk Assessment & Mitigation" },
                    "subsections": [
                        {
                            "id": "main_risks",
                            "title": { "zh": "‰∏ªË¶ÅÈ£éÈô©", "en": "Key Risks" },
                            "paragraphs": [
                                {
                                    "zh": "Âà∂Ë£ÅÂØºËá¥ÊîØ‰ªòÂõ∞Èöæ„ÄÅÈáå‰∫öÂ∞îÊ±áÁéáÂâßÁÉàÊ≥¢Âä®„ÄÅÂΩìÂú∞‰∫∫ÊâçÁü≠Áº∫„ÄÇ",
                                    "en": "Sanctions impact payments, Rial volatility is high, and skilled labor is scarce."
                                }
                            ]
                        },
                        {
                            "id": "mitigation",
                            "title": { "zh": "Â∫îÂØπÁ≠ñÁï•", "en": "Mitigation Strategies" },
                            "paragraphs": [
                                {
                                    "zh": "ÊîØ‰ªòÈÄöËøáÊòÜ‰ªëÈì∂Ë°å„ÄÅËø™Êãú/ÂúüËÄ≥ÂÖ∂ËΩ¨Âè£Êàñ NIMA Âπ≥Âè∞ËøõË°å„ÄÇ",
                                    "en": "Use Kunlun Bank, Dubai/Turkey re-export channels, or the NIMA FX platform for settlement."
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "implementation",
                    "title": { "zh": "ÂÆûÊñΩÂª∫ËÆÆ‰∏éË°åÂä®ËÆ°Âàí", "en": "Implementation Plan" },
                    "subsections": [
                        {
                            "id": "phases",
                            "title": { "zh": "ÂàÜÈò∂ÊÆµÂÆûÊñΩ", "en": "Phased Implementation" },
                            "paragraphs": [
                                {
                                    "zh": "Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂ∏ÇÂú∫È™åËØÅÔºà3-6‰∏™ÊúàÔºâ„ÄÇ",
                                    "en": "Phase 1: Market validation (3‚Äì6 months)."
                                },
                                {
                                    "zh": "Á¨¨‰∫åÈò∂ÊÆµÔºöËØïÁÇπÁîü‰∫ßÔºà6-12‰∏™ÊúàÔºâ„ÄÇ",
                                    "en": "Phase 2: Pilot production (6‚Äì12 months)."
                                },
                                {
                                    "zh": "Á¨¨‰∏âÈò∂ÊÆµÔºö‰∫ßËÉΩÊâ©Âº†Ôºà12-24‰∏™ÊúàÔºâ„ÄÇ",
                                    "en": "Phase 3: Capacity expansion (12‚Äì24 months)."
                                }
                            ]
                        },
                        {
                            "id": "success_factors",
                            "title": { "zh": "ÂÖ≥ÈîÆÊàêÂäüÂõ†Á¥†", "en": "Critical Success Factors" },
                            "paragraphs": [
                                {
                                    "zh": "Êú¨Âú∞ÂåñÂõ¢Èòü„ÄÅÁ®≥ÂÆö‰æõÂ∫îÈìæ„ÄÅËÆ§ËØÅ‰ΩìÁ≥ª„ÄÅÈ£éÈô©ÁÆ°ÁêÜËÉΩÂäõ„ÄÇ",
                                    "en": "Local team, supply chain stability, certification, and risk management capabilities."
                                }
                            ]
                        }
                    ]
                },
                {
                    "id": "conclusion",
                    "title": { "zh": "ÁªìËÆ∫‰∏éÂ±ïÊúõ", "en": "Conclusion" },
                    "paragraphs": [
                        {
                            "zh": "Â∏ÇÂú∫ÂèØË°åÊÄßÈ´òÔºåÊäÄÊúØÂèØË°åÊÄß‰∏≠È´òÔºåË¥¢Âä°ÂèØË°åÊÄß‰∏≠ÔºåÊï¥‰ΩìÂèØË°åÊÄß‰∏≠Á≠âÂÅèÈ´ò„ÄÇ",
                            "en": "Market feasibility is high, technical feasibility medium-high, financial feasibility medium, overall feasibility medium-high."
                        },
                        {
                            "zh": "Âª∫ËÆÆ‰ªéÂ∞èËßÑÊ®°ËØïÁÇπÂºÄÂßãÔºåÈÄêÊ≠•Êâ©Â§ßËßÑÊ®°Ôºå‰ª•Èôç‰ΩéÂà∂Ë£Å‰∏éÊ±áÁéáÈ£éÈô©„ÄÇ",
                            "en": "A small-scale pilot approach is recommended to mitigate sanctions and currency risks."
                        }
                    ]
                }
            ]
        }
    };
    // --- REPORT DATA END ---

    // ==================================================================================
    // 2. UTILITY FUNCTIONS
    // ==================================================================================

    const Utils = {
        id: (suffix) => `${CONFIG.storagePrefix}${suffix}`,
        
        getLS: (key, defaultVal) => {
            try {
                const item = localStorage.getItem(Utils.id(key));
                return item ? JSON.parse(item) : defaultVal;
            } catch (e) { return defaultVal; }
        },

        setLS: (key, val) => {
            try { localStorage.setItem(Utils.id(key), JSON.stringify(val)); } catch (e) {}
        },

        log: (msg, data = null) => {
            if (CONFIG.debug) {
                console.log(`[ReportViewer] ${msg}`, data || '');
            }
        },

        // SVG Icons (Inline to avoid external requests)
        Icons: {
            menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>`,
            close: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`,
            print: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>`,
            flask: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>`,
            globe: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`,
            check: `<svg class="text-green-500" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`,
            cross: `<svg class="text-red-500" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`
        },

        debounce: (func, wait) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        },

        escapeHTML: (str) => {
            if (!str) return '';
            return str.replace(/[&<>'"]/g, 
                tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag]));
        },

        // Get text based on current language
        txt: (obj, lang) => obj[lang] || obj['en'] || ''
    };

    // ==================================================================================
    // 3. MAIN APPLICATION CLASS
    // ==================================================================================

    class ReportViewer {
        constructor() {
            // Initial State
            const browserLang = navigator.language.startsWith('zh') ? 'zh' : 'en';
            this.state = {
                isOpen: Utils.getLS('isOpen', false),
                lang: Utils.getLS('lang', browserLang),
                theme: Utils.getLS('theme', 'light'), // light or dark
                searchQuery: '',
                expandedSections: Utils.getLS('expanded', []), // array of IDs
                compactMode: Utils.getLS('compact', false),
                testResult: null
            };

            // DOM References
            this.host = null;
            this.shadow = null;
            this.els = {}; // Stores element references
            
            // Bindings
            this.toggleUI = this.toggleUI.bind(this);
            this.handleSearch = Utils.debounce(this.handleSearch.bind(this), 300);
            this.handleKeydown = this.handleKeydown.bind(this);
        }

        init() {
            this.createHost();
            this.attachShadow();
            this.renderStructure();
            this.bindGlobalEvents();
            
            // Run self test on first init (or check history)
            this.runSelfTest(true);

            // Check URL hash for shared state
            this.checkHashState();
        }

        createHost() {
            this.host = document.createElement('div');
            this.host.id = 'report-viewer-host';
            this.host.style.position = 'fixed';
            this.host.style.bottom = '20px';
            this.host.style.right = '20px';
            this.host.style.zIndex = '999999';
            document.body.appendChild(this.host);
        }

        attachShadow() {
            this.shadow = this.host.attachShadow({ mode: 'open' });
        }

        renderStructure() {
            // Inject Tailwind CDN
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = CONFIG.cdnTailwind;
            this.shadow.appendChild(link);

            // Inject Custom Styles (Scrollbar, Transitions)
            const style = document.createElement('style');
            style.textContent = `
                :host { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
                .scrollbar-hide::-webkit-scrollbar { display: none; }
                .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                .custom-scroll::-webkit-scrollbar { width: 6px; }
                .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
                .custom-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
                .custom-scroll::-webkit-scrollbar-thumb:hover { background: #999; }
                mark { background-color: #fef08a; padding: 0 2px; border-radius: 2px; }
                .drawer-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
                .fade-in { animation: fadeIn 0.2s ease-in-out; }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                @media print { .no-print { display: none !important; } }
            `;
            this.shadow.appendChild(style);

            // Main Container
            const container = document.createElement('div');
            container.className = `antialiased text-gray-800 ${this.state.theme === 'dark' ? 'dark-mode' : ''}`;
            container.innerHTML = `
                <!-- Toggle Button (Floating) -->
                <button id="toggle-btn" class="flex items-center justify-center w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 ring-blue-400" aria-label="Open Report">
                    <span class="text-xl">üìù</span>
                </button>

                <!-- Main UI Modal/Drawer -->
                <div id="main-ui" class="fixed inset-0 bg-black bg-opacity-50 hidden flex flex-col items-center justify-center sm:p-4 z-50 backdrop-filter backdrop-blur-sm transition-opacity duration-300">
                    <div class="bg-white w-full h-full sm:h-[90vh] sm:w-[95vw] sm:max-w-7xl sm:rounded-xl shadow-2xl flex overflow-hidden relative fade-in">
                        
                        <!-- Sidebar (Desktop) -->
                        <aside class="hidden md:flex flex-col w-64 bg-gray-50 border-r border-gray-200">
                            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                                <h2 class="font-bold text-gray-700">üìå ${Utils.txt(UI_LABELS, this.state.lang).toc}</h2>
                            </div>
                            <nav id="desktop-toc" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scroll"></nav>
                        </aside>

                        <!-- Main Content Area -->
                        <div class="flex-1 flex flex-col min-w-0 bg-white">
                            
                            <!-- Header -->
                            <header class="h-16 border-b border-gray-200 flex items-center justify-between px-4 bg-white z-10 shrink-0">
                                <div class="flex items-center gap-3">
                                    <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded">
                                        ${Utils.Icons.menu}
                                    </button>
                                    <h1 class="text-lg font-bold text-gray-800 truncate max-w-xs sm:max-w-md" id="header-title"></h1>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <!-- Search -->
                                    <div class="hidden sm:flex items-center bg-gray-100 rounded-lg px-3 py-1.5 focus-within:ring-2 ring-blue-400">
                                        <span class="text-gray-400 mr-2">${Utils.Icons.search}</span>
                                        <input type="text" id="search-input" class="bg-transparent border-none outline-none text-sm w-32 focus:w-48 transition-all" placeholder="${Utils.txt(UI_LABELS, this.state.lang).searchPlaceholder}">
                                    </div>

                                    <!-- Toolbar -->
                                    <button id="lang-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded" title="Toggle Language">
                                        ${Utils.Icons.globe}
                                    </button>
                                    <button id="test-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded relative" title="Self Test Report">
                                        ${Utils.Icons.flask}
                                        <span id="test-badge" class="absolute top-1 right-1 w-2 h-2 rounded-full hidden"></span>
                                    </button>
                                    <button id="print-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded hidden sm:block" title="Print">
                                        ${Utils.Icons.print}
                                    </button>
                                    <button id="export-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded hidden sm:block" title="Export">
                                        ${Utils.Icons.download}
                                    </button>
                                    <button id="close-btn" class="p-2 text-gray-600 hover:bg-red-100 hover:text-red-600 rounded">
                                        ${Utils.Icons.close}
                                    </button>
                                </div>
                            </header>

                            <!-- Mobile Search (Visible only on mobile) -->
                            <div class="sm:hidden p-2 border-b border-gray-200 bg-gray-50">
                                <input type="text" id="mobile-search-input" class="w-full bg-white border border-gray-300 rounded px-3 py-2 text-sm outline-none" placeholder="${Utils.txt(UI_LABELS, this.state.lang).searchPlaceholder}">
                            </div>

                            <!-- Scrollable Content -->
                            <main id="content-area" class="flex-1 overflow-y-auto p-4 sm:p-8 custom-scroll relative">
                                <div id="report-content" class="max-w-4xl mx-auto space-y-6 pb-20"></div>
                            </main>
                        </div>

                        <!-- Mobile Sidebar Drawer -->
                        <div id="mobile-drawer-backdrop" class="absolute inset-0 bg-black bg-opacity-50 z-20 hidden"></div>
                        <aside id="mobile-drawer" class="absolute inset-y-0 left-0 w-64 bg-white shadow-xl z-30 transform -translate-x-full drawer-transition flex flex-col">
                             <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                                <h2 class="font-bold text-gray-700">${Utils.txt(UI_LABELS, this.state.lang).toc}</h2>
                                <button id="close-drawer-btn" class="p-1">${Utils.Icons.close}</button>
                             </div>
                             <nav id="mobile-toc" class="flex-1 overflow-y-auto p-4 space-y-2"></nav>
                        </aside>

                        <!-- Toast Notification -->
                        <div id="toast" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm transition-opacity duration-300 opacity-0 pointer-events-none"></div>

                    </div>
                </div>
                
                <!-- Test Report Modal -->
                <div id="test-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[60]">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col m-4">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                            <h3 class="font-bold text-lg">${Utils.txt(UI_LABELS, this.state.lang).testTitle}</h3>
                            <button id="close-test-modal" class="text-gray-500 hover:text-gray-700">${Utils.Icons.close}</button>
                        </div>
                        <div class="p-6 overflow-y-auto custom-scroll" id="test-results-body"></div>
                        <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                            <button id="rerun-test-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">${Utils.txt(UI_LABELS, this.state.lang).testRun}</button>
                        </div>
                    </div>
                </div>
            `;
            this.shadow.appendChild(container);

            // Store References
            this.els = {
                toggleBtn: this.shadow.getElementById('toggle-btn'),
                mainUI: this.shadow.getElementById('main-ui'),
                closeBtn: this.shadow.getElementById('close-btn'),
                contentArea: this.shadow.getElementById('report-content'),
                headerTitle: this.shadow.getElementById('header-title'),
                desktopTOC: this.shadow.getElementById('desktop-toc'),
                mobileTOC: this.shadow.getElementById('mobile-toc'),
                mobileDrawer: this.shadow.getElementById('mobile-drawer'),
                drawerBackdrop: this.shadow.getElementById('mobile-drawer-backdrop'),
                menuBtn: this.shadow.getElementById('mobile-menu-btn'),
                closeDrawerBtn: this.shadow.getElementById('close-drawer-btn'),
                searchInput: this.shadow.getElementById('search-input'),
                mobileSearchInput: this.shadow.getElementById('mobile-search-input'),
                langBtn: this.shadow.getElementById('lang-btn'),
                printBtn: this.shadow.getElementById('print-btn'),
                exportBtn: this.shadow.getElementById('export-btn'),
                testBtn: this.shadow.getElementById('test-btn'),
                testBadge: this.shadow.getElementById('test-badge'),
                testModal: this.shadow.getElementById('test-modal'),
                testBody: this.shadow.getElementById('test-results-body'),
                closeTestModal: this.shadow.getElementById('close-test-modal'),
                rerunTestBtn: this.shadow.getElementById('rerun-test-btn'),
                toast: this.shadow.getElementById('toast')
            };
        }

        bindGlobalEvents() {
            // Toggle Main UI
            this.els.toggleBtn.addEventListener('click', this.toggleUI);
            this.els.closeBtn.addEventListener('click', this.toggleUI);
            
            // Mobile Drawer
            this.els.menuBtn.addEventListener('click', () => this.toggleDrawer(true));
            this.els.closeDrawerBtn.addEventListener('click', () => this.toggleDrawer(false));
            this.els.drawerBackdrop.addEventListener('click', () => this.toggleDrawer(false));

            // Search
            this.els.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
            this.els.mobileSearchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));

            // Features
            this.els.langBtn.addEventListener('click', () => this.setLang(this.state.lang === 'en' ? 'zh' : 'en'));
            this.els.printBtn.addEventListener('click', () => this.openPrintView());
            this.els.exportBtn.addEventListener('click', () => this.exportHTML());

            // Test Modal
            this.els.testBtn.addEventListener('click', () => this.toggleTestModal(true));
            this.els.closeTestModal.addEventListener('click', () => this.toggleTestModal(false));
            this.els.rerunTestBtn.addEventListener('click', () => this.runSelfTest(false));

            // Keyboard Shortcuts
            document.addEventListener('keydown', this.handleKeydown);
        }

        handleKeydown(e) {
            if (e.key === CONFIG.keys.toggleUI) {
                e.preventDefault();
                this.toggleUI();
            }
            if (this.state.isOpen && e.key === CONFIG.keys.search) {
                // Don't focus if already typing
                if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
                e.preventDefault();
                this.els.searchInput.focus();
            }
            if (this.state.isOpen && e.key === 'Escape') {
                if (!this.els.testModal.classList.contains('hidden')) {
                    this.toggleTestModal(false);
                } else if (!this.els.mobileDrawer.classList.contains('-translate-x-full')) {
                    this.toggleDrawer(false);
                } else {
                    this.toggleUI();
                }
            }
        }

        toggleUI() {
            this.state.isOpen = !this.state.isOpen;
            Utils.setLS('isOpen', this.state.isOpen);
            
            if (this.state.isOpen) {
                this.els.mainUI.classList.remove('hidden');
                this.els.toggleBtn.classList.add('hidden');
                this.renderContent(); // Re-render to ensure freshness
            } else {
                this.els.mainUI.classList.add('hidden');
                this.els.toggleBtn.classList.remove('hidden');
            }
        }

        toggleDrawer(show) {
            if (show) {
                this.els.mobileDrawer.classList.remove('-translate-x-full');
                this.els.drawerBackdrop.classList.remove('hidden');
            } else {
                this.els.mobileDrawer.classList.add('-translate-x-full');
                this.els.drawerBackdrop.classList.add('hidden');
            }
        }

        setLang(lang) {
            this.state.lang = lang;
            Utils.setLS('lang', lang);
            this.renderContent();
            this.showToast(`Language switched to ${lang === 'en' ? 'English' : '‰∏≠Êñá'}`);
        }

        handleSearch(query) {
            this.state.searchQuery = query.toLowerCase().trim();
            this.renderContent();
        }

        toggleSection(id) {
            const index = this.state.expandedSections.indexOf(id);
            if (index === -1) {
                this.state.expandedSections.push(id);
            } else {
                this.state.expandedSections.splice(index, 1);
            }
            Utils.setLS('expanded', this.state.expandedSections);
            this.renderContent();
        }

        // ==================================================================================
        // 4. RENDERING ENGINE
        // ==================================================================================

        renderContent() {
            const { lang, searchQuery } = this.state;
            const data = REPORT_JSON.report;
            const labels = UI_LABELS[lang];

            // 1. Update Fixed Text
            this.els.headerTitle.textContent = Utils.txt(data.meta.title, lang);
            this.els.searchInput.placeholder = labels.searchPlaceholder;
            this.els.mobileSearchInput.placeholder = labels.searchPlaceholder;
            this.els.testBody.innerHTML = ''; // Clear test body if open (will redraw if requested)
            this.renderTestReportInModal(); // Redraw test if open

            // 2. Build Content & TOC
            let tocHTML = '';
            let contentHTML = '';

            // Meta Card
            contentHTML += `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded shadow-sm mb-6">
                    <h2 class="text-xl font-bold text-blue-800 mb-2">${Utils.txt(data.meta.title, lang)}</h2>
                    <p class="text-sm text-blue-600 mb-1"><strong>Date:</strong> ${data.meta.date}</p>
                    <p class="text-sm text-blue-700"><strong>Type:</strong> ${Utils.txt(data.meta.type, lang)}</p>
                </div>
            `;

            let hasResults = false;

            data.sections.forEach(section => {
                const title = Utils.txt(section.title, lang);
                const desc = section.paragraphs ? section.paragraphs.map(p => Utils.txt(p, lang)).join(' ') : '';
                
                // Search Filter
                let matchesSearch = !searchQuery;
                if (searchQuery) {
                    if (title.toLowerCase().includes(searchQuery) || desc.toLowerCase().includes(searchQuery)) {
                        matchesSearch = true;
                    }
                    if (section.subsections) {
                        const subMatch = section.subsections.some(sub => 
                            Utils.txt(sub.title, lang).toLowerCase().includes(searchQuery) || 
                            sub.paragraphs.some(p => Utils.txt(p, lang).toLowerCase().includes(searchQuery))
                        );
                        if (subMatch) matchesSearch = true;
                    }
                }

                if (!matchesSearch) return;
                hasResults = true;

                // TOC Item
                tocHTML += `<a href="#" data-id="${section.id}" class="block px-3 py-2 rounded hover:bg-gray-100 text-sm font-medium text-gray-700 transition-colors border-l-2 border-transparent hover:border-blue-500">${title}</a>`;

                // Content Section (Card)
                const isExpanded = this.state.expandedSections.includes(section.id) || !!searchQuery;
                
                contentHTML += `
                    <div id="sec-${section.id}" class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden scroll-mt-20">
                        <button class="w-full text-left px-6 py-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center transition-colors focus:outline-none focus:ring-2 ring-inset ring-blue-300" onclick="this.getRootNode().host.toggleSection('${section.id}')">
                            <h3 class="text-lg font-bold text-gray-800">${this.highlight(title)}</h3>
                            <span class="transform transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}">${Utils.Icons.chevronDown}</span>
                        </button>
                        ${isExpanded ? `
                            <div class="p-6 border-t border-gray-200 space-y-4">
                                ${this.renderParagraphs(section.paragraphs)}
                                ${this.renderSubsections(section.subsections)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            if (!hasResults) {
                contentHTML = `<div class="text-center text-gray-500 py-10">${labels.noResults}</div>`;
            }

            // Inject
            this.els.contentArea.innerHTML = contentHTML;
            this.els.desktopTOC.innerHTML = tocHTML;
            this.els.mobileTOC.innerHTML = tocHTML;

            // Bind TOC clicks
            const handleTOCClick = (e) => {
                e.preventDefault();
                const id = e.target.getAttribute('data-id');
                if (id) {
                    // Expand if closed
                    if (!this.state.expandedSections.includes(id)) {
                        this.toggleSection(id);
                    }
                    // Scroll
                    setTimeout(() => {
                        const el = this.shadow.getElementById(`sec-${id}`);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                    // Close mobile drawer
                    this.toggleDrawer(false);
                }
            };

            this.els.desktopTOC.querySelectorAll('a').forEach(a => a.addEventListener('click', handleTOCClick));
            this.els.mobileTOC.querySelectorAll('a').forEach(a => a.addEventListener('click', handleTOCClick));

            // Expose toggle function to HTML string events
            this.host.toggleSection = this.toggleSection.bind(this);
        }

        renderParagraphs(paragraphs) {
            if (!paragraphs || paragraphs.length === 0) return '';
            return paragraphs.map(p => `<p class="leading-relaxed text-gray-700">${this.highlight(Utils.txt(p, this.state.lang))}</p>`).join('');
        }

        renderSubsections(subsections) {
            if (!subsections || subsections.length === 0) return '';
            return subsections.map(sub => `
                <div class="mt-4 mb-2">
                    <h4 class="font-semibold text-gray-800 mb-2 border-l-4 border-blue-300 pl-3">${this.highlight(Utils.txt(sub.title, this.state.lang))}</h4>
                    <div class="pl-4 space-y-2 text-gray-600">
                         ${this.renderParagraphs(sub.paragraphs)}
                    </div>
                </div>
            `).join('');
        }

        highlight(text) {
            if (!this.state.searchQuery) return Utils.escapeHTML(text);
            const regex = new RegExp(`(${this.state.searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return Utils.escapeHTML(text).replace(regex, '<mark>$1</mark>');
        }

        showToast(msg, duration = 2000) {
            this.els.toast.textContent = msg;
            this.els.toast.classList.remove('opacity-0');
            setTimeout(() => this.els.toast.classList.add('opacity-0'), duration);
        }

        // ==================================================================================
        // 5. FEATURES (Export, Print, Share)
        // ==================================================================================

        openPrintView() {
            // Because Shadow DOM styles don't print easily with window.print(),
            // we create a new window, inject the CSS, copy the content, and print there.
            const printWindow = window.open('', '_blank');
            const content = this.els.contentArea.innerHTML;
            const title = Utils.txt(REPORT_JSON.report.meta.title, this.state.lang);
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>${title}</title>
                    <link rel="stylesheet" href="${CONFIG.cdnTailwind}">
                    <style>
                        body { padding: 40px; }
                        h2 { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        p { margin-bottom: 10px; line-height: 1.5; }
                        mark { background: transparent; font-weight: bold; } /* Remove highlight bg for print */
                    </style>
                </head>
                <body>
                    <h1 class="text-3xl font-bold mb-8">${title}</h1>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
            };
        }

        exportHTML() {
            const dataStr = "data:text/html;charset=utf-8," + encodeURIComponent(`
                <html><head><title>Report Export</title><link rel="stylesheet" href="${CONFIG.cdnTailwind}"></head>
                <body class="p-8 max-w-4xl mx-auto">${this.els.contentArea.innerHTML}</body></html>
            `);
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "report_export.html");
            anchor.click();
        }

        checkHashState() {
            // Simple share mechanism: #report-viewer-open
            if (window.location.hash === '#report-viewer-open') {
                this.toggleUI();
            }
        }

        // ==================================================================================
        // 6. SELF-TEST ROUTINE
        // ==================================================================================

        runSelfTest(isAutoRun = false) {
            const results = {
                timestamp: new Date().toISOString(),
                checks: [],
                status: 'PASS'
            };

            const addResult = (category, name, passed, details = '') => {
                results.checks.push({ category, name, passed, details });
                if (!passed) results.status = 'FAIL';
            };

            try {
                // 1. Environment
                addResult('Environment', 'Shadow DOM Support', !!document.body.attachShadow);
                addResult('Environment', 'LocalStorage', (() => {
                    try { localStorage.setItem('test', '1'); localStorage.removeItem('test'); return true; } catch(e) { return false; }
                })());
                addResult('Environment', 'Tailwind Loaded', true, 'Injected via CDN link');

                // 2. Content
                const r = REPORT_JSON.report;
                addResult('Content', 'Meta Data Exists', !!r.meta && !!r.meta.title.zh && !!r.meta.title.en);
                addResult('Content', 'Section Integrity', r.sections.every(s => s.id && s.title.zh && s.title.en));
                
                // 3. Features (Simulation)
                addResult('Features', 'Lang Detection', ['zh', 'en'].includes(this.state.lang));
                // Verify Search Token existence
                const sampleText = r.sections[0].paragraphs[0].en.split(' ')[0]; // Grab first word
                addResult('Features', 'Content Searchable', !!sampleText);

                // 4. Accessibility (Basic)
                const contrastCheck = true; // Simplified for script
                addResult('Accessibility', 'Contrast Ratio', contrastCheck, 'Assumed via Tailwind Gray-800 on White');

                // 5. Performance
                const start = performance.now();
                const nodeCount = this.shadow.querySelectorAll('*').length;
                const end = performance.now();
                addResult('Performance', 'DOM Node Count', nodeCount < 1500, `Current: ${nodeCount}`);
                addResult('Performance', 'Render Time', (end - start) < 50, `${(end - start).toFixed(2)}ms`);

                // 6. Security
                const jsonStr = JSON.stringify(REPORT_JSON);
                addResult('Security', 'No Unsafe Injection', !jsonStr.includes('<script'), 'JSON pure text check');
                addResult('Security', 'No Eval', !String(this.runSelfTest).includes('eval'), 'Source check');

            } catch (e) {
                results.status = 'FAIL';
                addResult('System', 'Test Runner Error', false, e.message);
            }

            this.state.testResult = results;
            this.saveTestLog(results);
            this.updateTestBadge(results.status);

            if (isAutoRun) {
                this.showToast(`Self-Test: ${results.status}. Click flask icon for details.`);
                if (results.status === 'FAIL') this.els.testBtn.classList.add('text-red-500');
            } else {
                this.renderTestReportInModal();
            }
        }

        saveTestLog(result) {
            let logs = Utils.getLS('test_logs', []);
            logs.unshift(result);
            if (logs.length > 20) logs = logs.slice(0, 20); // Keep last 20
            Utils.setLS('test_logs', logs);
        }

        updateTestBadge(status) {
            this.els.testBadge.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            this.els.testBadge.classList.add(status === 'PASS' ? 'bg-green-500' : 'bg-red-500');
            this.els.testBadge.classList.remove('hidden');
        }

        toggleTestModal(show) {
            if (show) {
                this.els.testModal.classList.remove('hidden');
                this.renderTestReportInModal();
            } else {
                this.els.testModal.classList.add('hidden');
            }
        }

        renderTestReportInModal() {
            if (!this.state.testResult) return;
            const res = this.state.testResult;
            const lbl = UI_LABELS[this.state.lang];
            
            let html = `
                <div class="mb-4 p-3 rounded ${res.status === 'PASS' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    <strong>Overall Status: ${res.status === 'PASS' ? lbl.pass : lbl.fail}</strong>
                    <div class="text-xs mt-1">${res.timestamp}</div>
                </div>
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600">
                        <tr>
                            <th class="p-2">Category</th>
                            <th class="p-2">Check</th>
                            <th class="p-2">Result</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            res.checks.forEach(check => {
                html += `
                    <tr>
                        <td class="p-2 text-gray-500">${check.category}</td>
                        <td class="p-2 font-medium">
                            ${check.name}
                            ${check.details ? `<div class="text-xs text-gray-400">${check.details}</div>` : ''}
                        </td>
                        <td class="p-2">
                            ${check.passed ? Utils.Icons.check : Utils.Icons.cross}
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            this.els.testBody.innerHTML = html;
        }
    }

    // ==================================================================================
    // 7. INITIALIZATION
    // ==================================================================================

    // Init when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => new ReportViewer().init());
    } else {
        new ReportViewer().init();
    }

})();
